<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AX System</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <style>
    /* --- MAIN CSS --- */
    :root {
      --bg-color: #000000;
      --card-bg: #121212;
      --text-main: #ffffff;
      --text-muted: #888888;
      --border-color: #333333;
      --accent-color: #ffffff;
      --hover-color: #222222;
      --success-color: #4caf50;
      --error-color: #f44336;
      --font-main: 'Inter', system-ui, sans-serif;
      --radius: 0px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }

    body {
      background-color: var(--bg-color);
      color: var(--text-main);
      font-family: var(--font-main);
      min-height: 100vh;
      line-height: 1.5;
      display: flex;
      flex-direction: column;
    }

    /* Helper Classes */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 40px 20px;
      width: 100%;
    }

    /* Login Styles */
    .login-card { 
        max-width: 400px; 
        text-align: center; 
        margin: auto; /* Center vertically if flex parent */
    }
    .logo { 
        font-size: 48px; font-weight: 800; margin-bottom: 20px; 
        background: linear-gradient(45deg, #fff, #888); 
        -webkit-background-clip: text; 
        -webkit-text-fill-color: transparent; 
    }
    .password-wrapper { position: relative; width: 100%; margin-bottom: 15px; }
    .password-toggle {
      position: absolute; right: 15px; top: 50%; transform: translateY(-50%);
      cursor: pointer; opacity: 0.6; display: flex; align-items: center;
    }
    .password-toggle:hover { opacity: 1; }
    .password-toggle svg { width: 20px; height: 20px; fill: var(--text-muted); }

    /* Inputs & Buttons */
    .input-field {
      width: 100%;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      color: var(--text-main);
      padding: 12px 15px;
      font-size: 16px;
      margin-bottom: 10px;
      transition: border-color 0.2s;
    }
    .input-field:focus { border-color: var(--text-main); }

    .btn {
      background: transparent;
      color: var(--text-main);
      border: 1px solid var(--text-main);
      padding: 10px 20px;
      cursor: pointer;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 1px;
      transition: all 0.2s;
      display: inline-flex; align-items: center; justify-content: center;
    }
    .btn:hover { background: var(--text-main); color: var(--bg-color); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-primary { background: var(--text-main); color: var(--bg-color); font-weight: 600; }
    .btn-primary:hover { background: #ddd; }
    .btn-sm { padding: 5px 10px; font-size: 12px; }

    /* Header & Layout */
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; border-bottom: 1px solid var(--border-color); padding-bottom: 20px; }
    h1 { font-size: 32px; letter-spacing: 4px; font-weight: 300; margin: 0; }
    
    .profile-menu-container { position: relative; }
    .dropdown-menu {
      display: none;
      position: absolute;
      right: 0;
      top: 100%;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      min-width: 150px;
      z-index: 1000;
      margin-top: 5px;
    }
    .menu-item {
      display: block; width: 100%; text-align: left; padding: 10px 15px;
      background: none; border: none; color: var(--text-main); cursor: pointer;
    }
    .menu-item:hover { background: var(--hover-color); }

    /* Tabs */
    .tabs { display: flex; gap: 10px; margin-bottom: 30px; border-bottom: 1px solid var(--border-color); }
    .tab {
      padding: 10px 20px;
      background: transparent;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 1px;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }
    .tab:hover { color: var(--text-main); }
    .tab.active { color: var(--text-main); border-bottom-color: var(--text-main); }
    
    .tab-content { display: none; animation: fadeIn 0.3s ease; }
    .tab-content.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* Tables */
    .table-responsive { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border-color); }
    th { color: var(--text-muted); font-weight: 400; text-transform: uppercase; font-size: 12px; }
    
    /* Schedule Specific */
    .schedule-switch { margin-bottom: 20px; display: flex; gap: 10px; }
    .schedule-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .month-nav { display: flex; align-items: center; }
    .sticky-col { position: sticky; left: 0; background: var(--bg-color); z-index: 1; border-right: 1px solid var(--border-color); }
    
    .shift-select {
      background: transparent; border: none; color: var(--text-main); 
      width: 100%; min-width: 40px; cursor: pointer; appearance: none; -webkit-appearance: none; text-align: center;
    }
    .shift-select:hover { background: var(--hover-color); }
    .shift-1 { color: #90caf9; font-weight: bold; } /* Пример цветов */
    .shift-2 { color: #a5d6a7; font-weight: bold; }
    .shift-none { color: #444; }
    .saving { opacity: 0.5; }

    /* --- CALENDAR CSS --- */
    .cal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 20px; }
    .cal-title { font-weight: 300; font-size: 24px; text-transform: uppercase; letter-spacing: 2px; }
    .cal-nav { display: flex; gap: 10px; }
    .cal-btn { background: transparent; color: var(--text-main); border: 1px solid var(--border-color); padding: 8px 12px; cursor: pointer; font-size: 14px; }
    .cal-btn:hover { background: var(--text-main); color: var(--bg-color); }
    .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: var(--border-color); border: 1px solid var(--border-color); }
    .cal-dow { text-align: center; color: var(--text-muted); padding: 15px 5px; font-size: 10px; text-transform: uppercase; background: var(--card-bg); }
    .cal-day { min-height: 100px; background: var(--card-bg); padding: 10px; display: flex; flex-direction: column; position: relative; }
    .cal-day:hover { background: #1a1a1a; }
    .cal-day.today { background: #1a1a1a; }
    .cal-day.today::after { content: ''; position: absolute; top: 10px; right: 10px; width: 6px; height: 6px; background: var(--accent-color); border-radius: 50%; }
    .cal-day.other { opacity: 0.3; }
    .daynum { font-weight: 300; font-size: 14px; color: var(--text-muted); margin-bottom: 10px; }
    .shift-marker { font-size: 10px; color: var(--text-main); margin-top: 5px; padding: 2px 0; border-left: 2px solid var(--text-main); padding-left: 8px; }

    /* Merch Grid */
    .merch-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; }
    .photo-card { height: 200px; background-size: cover; background-position: center; border: 1px solid var(--border-color); position: relative; }
    .photo-title { position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.7); padding: 10px; font-size: 12px; }

    /* Loader */
    .loader { text-align: center; padding: 20px; color: var(--text-muted); }
  </style>
</head>
<body>

  <!-- ==================== LOGIN VIEW ==================== -->
  <div id="login-view" class="container login-card" style="display:none; height: 100vh; display: flex; flex-direction: column; justify-content: center;">
    <div class="logo">AX</div>
    <h2>Вход в систему</h2>
    <p style="margin-bottom: 20px; color: #666;">Введите данные сотрудника</p>
    
    <input type="text" id="loginEmail" placeholder="Логин" class="input-field">
    
    <div class="password-wrapper">
      <input type="password" id="loginPassword" placeholder="Пароль" class="input-field" style="margin-bottom: 0;">
      <div class="password-toggle" id="togglePassword">
        <svg viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
      </div>
    </div>
    
    <button class="btn btn-primary" style="width: 100%; margin-top: 20px;" id="btnLogin">Войти</button>
    <div id="loginErrorMsg" style="color: #f44336; margin-top: 15px; font-size: 14px; min-height: 20px;"></div>
  </div>

  <!-- ==================== APP VIEW ==================== -->
  <div id="app-view" class="container" style="display:none;">
    <div class="header">
      <div class="header-left">
        <h1>AX</h1>
      </div>
      
      <div class="actions">
        <div class="profile-menu-container">
          <button class="btn btn-sm" id="profileBtn">
            <span id="headerLogin">...</span> 
            <span id="headerRole" class="badge">...</span>
          </button>
          <div class="dropdown-menu" id="profileMenu">
            <button id="logoutBtn" class="menu-item">Выйти</button>
          </div>
        </div>
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="schedule">График</button>
      <button class="tab" data-tab="operations">Операции</button>
      <button class="tab" data-tab="1s">1С</button>
      <button class="tab" data-tab="merch">Мерч</button>
      <button class="tab" data-tab="admin" id="adminTab" style="display:none">Сотрудники</button>
    </div>

    <!-- CONTENT: SCHEDULE -->
    <div class="tab-content active" id="schedule">
      <div class="schedule-switch">
        <button class="btn btn-sm active" id="viewMySched">Мой</button>
        <button class="btn btn-sm" id="viewTeamSched">Общий</button>
      </div>
      
      <div id="myScheduleView">
        <div id="calendar-wrapper"></div>
      </div>

      <div id="teamScheduleView" style="display:none;">
        <div id="schedule-manager"></div>
      </div>
    </div>

    <!-- CONTENT: OPERATIONS -->
    <div class="tab-content" id="operations">
      <h2>Операции</h2>
      <p>Раздел в разработке</p>
    </div>

    <!-- CONTENT: 1S -->
    <div class="tab-content" id="1s">
      <h2>Инструкции 1С</h2>
      <input type="text" class="input-field search-input" placeholder="Поиск инструкций...">
      <div class="list-group" style="margin-top: 20px;"></div>
    </div>

    <!-- CONTENT: MERCH -->
    <div class="tab-content" id="merch">
      <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
        <h2>Мерчандайзинг</h2>
        <button class="btn btn-sm" id="btnUploadMerch">Добавить фото</button>
        <input type="file" id="uploadMerchInput" hidden accept="image/*">
      </div>
      <div class="merch-grid" id="merchGrid"></div>
    </div>

    <!-- CONTENT: ADMIN -->
    <div class="tab-content" id="admin">
      <h2>Управление сотрудниками</h2>
      <div style="margin-bottom: 20px; padding: 20px; border: 1px solid var(--border-color);">
        <h3>Новый сотрудник</h3>
        <input type="text" id="newUserName" placeholder="ФИО" class="input-field">
        <input type="text" id="newUserEmail" placeholder="Логин" class="input-field">
        <input type="text" id="newUserPass" placeholder="Пароль" class="input-field">
        <select id="newUserRole" class="input-field">
          <option value="seller">Продавец</option>
          <option value="senior_seller">Старший продавец</option>
          <option value="director">Директор</option>
        </select>
        <button class="btn btn-primary" id="btnCreateUser">Создать</button>
      </div>
      
      <table id="usersTable">
        <thead>
          <tr>
            <th>Сотрудник</th>
            <th>Роль</th>
            <th>Действия</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    // --- 1. SUPABASE CONFIG ---
    const SUPABASE_URL = 'https://uuhsjusmhmmjceujzoiw.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV1aHNqdXNtaG1tamNldWp6b2l3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2MDU0MTUsImV4cCI6MjA4MTE4MTQxNX0.zaOtLcZGoNV77AiLrbODv3gIamlHWh8QwbBdWeOfJLw';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // --- 2. GLOBAL STATE ---
    let currentUser = null;

    // --- 3. HELPER FUNCTIONS (API) ---
    async function loginUser(login, password) {
      const { data, error } = await supabase
        .from('employees')
        .select('*')
        .eq('login', login)
        .eq('password', password)
        .single();

      if (error || !data) throw new Error('Неверный логин или пароль');
      localStorage.setItem('ax_user', JSON.stringify(data));
      return data;
    }

    function getCurrentUser() {
      const userStr = localStorage.getItem('ax_user');
      return userStr ? JSON.parse(userStr) : null;
    }

    function logoutUser() {
      localStorage.removeItem('ax_user');
      location.reload();
    }

    async function getAllEmployees() {
      const { data } = await supabase.from('employees').select('*').order('full_name');
      return data || [];
    }
    
    async function createEmployee(data) {
      return await supabase.from('employees').insert(data);
    }
    
    async function deleteEmployee(id) {
      return await supabase.from('employees').delete().eq('id', id);
    }
    
    async function getShiftTypes() {
      const { data } = await supabase.from('shifts').select('*').order('id');
      return data || [];
    }

    async function getMerchItems() {
      const { data } = await supabase.from('merch_items').select('*');
      return data || [];
    }
    
    async function createMerchItem(title, url) {
      return await supabase.from('merch_items').insert({ title, image_url: url });
    }
    
    async function uploadFile(bucket, file) {
      const ext = file.name.split('.').pop();
      const path = `${Math.random()}.${ext}`;
      await supabase.storage.from(bucket).upload(path, file);
      const { data } = supabase.storage.from(bucket).getPublicUrl(path);
      return data.publicUrl;
    }

    // --- 4. CLASSES ---
    
    class Calendar {
      constructor(containerId) {
        this.container = document.getElementById(containerId);
        this.cursor = new Date();
        this.shifts = new Map(); 
        this.init();
      }

      async init() {
        this.renderStructure();
        this.attachEvents();
        await this.loadMyShifts();
      }

      async loadMyShifts() {
        if (!currentUser) return;
        const y = this.cursor.getFullYear();
        const m = this.cursor.getMonth() + 1;
        const monthStr = `${y}-${String(m).padStart(2, '0')}`;

        const { data } = await supabase
          .from('schedule')
          .select('date, shift_id, shifts(title, start_time, end_time)')
          .eq('user_id', currentUser.id)
          .eq('month', monthStr);

        this.shifts.clear();
        if (data) {
          data.forEach(item => {
            if (item.shift_id && item.shifts) {
              this.shifts.set(item.date, item.shifts);
            }
          });
        }
        this.render();
      }

      renderStructure() {
        this.container.innerHTML = `
          <div class="card calendar-card" style="background:transparent; border:none; padding:0;">
            <div class="cal-header">
              <div class="cal-title" id="calTitle"></div>
              <div class="cal-nav">
                <button class="cal-btn" id="calPrev">←</button>
                <button class="cal-btn" id="calToday">Сегодня</button>
                <button class="cal-btn" id="calNext">→</button>
              </div>
            </div>
            <div class="cal-grid" id="calDow"></div>
            <div class="cal-grid" id="calGrid"></div>
          </div>
        `;
        const dowRow = document.getElementById('calDow');
        ['Пн','Вт','Ср','Чт','Пт','Сб','Вс'].forEach(d => {
          const el = document.createElement('div');
          el.className = 'cal-dow';
          el.textContent = d;
          dowRow.appendChild(el);
        });
      }

      attachEvents() {
        document.getElementById('calPrev').onclick = () => { this.cursor.setMonth(this.cursor.getMonth() - 1); this.loadMyShifts(); };
        document.getElementById('calNext').onclick = () => { this.cursor.setMonth(this.cursor.getMonth() + 1); this.loadMyShifts(); };
        document.getElementById('calToday').onclick = () => { this.cursor = new Date(); this.loadMyShifts(); };
      }

      render() {
        const grid = document.getElementById('calGrid');
        const title = document.getElementById('calTitle');
        grid.innerHTML = '';
        const y = this.cursor.getFullYear();
        const m = this.cursor.getMonth();
        title.textContent = new Date(y, m, 1).toLocaleDateString('ru-RU', { month: 'long', year: 'numeric' });
        
        const firstDay = new Date(y, m, 1);
        let startOffset = firstDay.getDay() || 7;
        startOffset -= 1;

        for(let i=0; i<startOffset; i++) {
          const el = document.createElement('div'); el.className = 'cal-day other'; grid.appendChild(el);
        }

        const daysInMonth = new Date(y, m+1, 0).getDate();
        const todayStr = new Date().toISOString().slice(0, 10);

        for(let d=1; d<=daysInMonth; d++) {
          const dateObj = new Date(y, m, d);
          const dateKey = new Date(dateObj.getTime() - (dateObj.getTimezoneOffset() * 60000)).toISOString().slice(0, 10);
          
          const cell = document.createElement('div');
          cell.className = 'cal-day';
          if (dateKey === todayStr) cell.classList.add('today');

          const num = document.createElement('div'); num.className = 'daynum'; num.textContent = d;
          cell.appendChild(num);

          if (this.shifts.has(dateKey)) {
            const shift = this.shifts.get(dateKey);
            const marker = document.createElement('div');
            marker.className = 'shift-marker';
            marker.textContent = `${shift.start_time.slice(0,5)}-${shift.end_time.slice(0,5)}`;
            cell.appendChild(marker);
            cell.style.background = '#e3f2fd';
          }
          grid.appendChild(cell);
        }
      }
    }

    class ScheduleManager {
      constructor(containerId) {
        this.container = document.getElementById(containerId);
        this.currentDate = new Date();
        this.employees = [];
        this.shiftTypes = [];
        this.scheduleData = [];
      }

      async init() {
        this.container.innerHTML = '<div class="loader">Загрузка графика...</div>';
        const [employees, shifts] = await Promise.all([ getAllEmployees(), getShiftTypes() ]);
        this.employees = employees;
        this.shiftTypes = shifts;
        this.renderControls();
        await this.loadMonthData();
      }

      renderControls() {
        const y = this.currentDate.getFullYear();
        const m = this.currentDate.getMonth();
        const monthName = new Date(y, m, 1).toLocaleDateString('ru-RU', { month: 'long', year: 'numeric' });

        this.container.innerHTML = `
          <div class="schedule-controls">
            <div class="month-nav">
              <button id="schedPrev" class="btn btn-sm">←</button>
              <h2 style="text-transform: capitalize; margin: 0 15px;">${monthName}</h2>
              <button id="schedNext" class="btn btn-sm">→</button>
            </div>
            <div class="actions">
               <button class="btn btn-primary" onclick="alert('Функция копирования в разработке')">Копировать прошлый</button>
            </div>
          </div>
          <div class="table-responsive">
            <table class="schedule-table" id="schedTable">
              <thead><tr id="schedHeaderRow"><th>Сотрудник</th></tr></thead>
              <tbody id="schedBody"></tbody>
            </table>
          </div>
        `;
        document.getElementById('schedPrev').onclick = () => this.changeMonth(-1);
        document.getElementById('schedNext').onclick = () => this.changeMonth(1);
      }

      changeMonth(delta) {
        this.currentDate.setMonth(this.currentDate.getMonth() + delta);
        this.renderControls();
        this.loadMonthData();
      }

      async loadMonthData() {
        const y = this.currentDate.getFullYear();
        const m = this.currentDate.getMonth() + 1;
        const monthStr = `${y}-${String(m).padStart(2, '0')}`;
        const { data } = await supabase.from('schedule').select('*').eq('month', monthStr);
        this.scheduleData = data || [];
        this.renderTable(y, m - 1);
      }

      renderTable(year, month) {
        const headerRow = document.getElementById('schedHeaderRow');
        const tbody = document.getElementById('schedBody');
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        while (headerRow.children.length > 1) headerRow.removeChild(headerRow.lastChild);

        for (let d = 1; d <= daysInMonth; d++) {
          const th = document.createElement('th');
          const dateObj = new Date(year, month, d);
          const dayName = dateObj.toLocaleDateString('ru-RU', { weekday: 'short' });
          th.innerHTML = `${d}<br><small>${dayName}</small>`;
          if (dayName === 'сб' || dayName === 'вс') th.classList.add('weekend');
          headerRow.appendChild(th);
        }
        const thTotal = document.createElement('th'); thTotal.textContent = 'Итого'; headerRow.appendChild(thTotal);
        tbody.innerHTML = '';
        if (this.employees.length === 0) { tbody.innerHTML = '<tr><td colspan="35">Нет сотрудников.</td></tr>'; return; }

        this.employees.forEach(user => {
          const tr = document.createElement('tr');
          const tdName = document.createElement('td');
          tdName.className = 'sticky-col';
          tdName.textContent = user.full_name || 'Без имени';
          tr.appendChild(tdName);
          let totalHours = 0;

          for (let d = 1; d <= daysInMonth; d++) {
            const td = document.createElement('td');
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
            const record = this.scheduleData.find(s => s.user_id === user.id && s.date === dateStr);
            const shiftId = record ? record.shift_id : '';

            const select = document.createElement('select');
            select.className = `shift-select shift-${shiftId || 'none'}`;
            select.dataset.userId = user.id;
            select.dataset.date = dateStr;
            
            const optDefault = document.createElement('option'); optDefault.value = ''; optDefault.text = ''; select.appendChild(optDefault);
            this.shiftTypes.forEach(st => {
              const opt = document.createElement('option');
              opt.value = st.id; opt.textContent = st.id; opt.title = st.title;
              if (String(st.id) === String(shiftId)) opt.selected = true;
              select.appendChild(opt);
            });

            if (shiftId) {
              const shiftInfo = this.shiftTypes.find(s => s.id === shiftId);
              if (shiftInfo) totalHours += 9;
            }
            select.onchange = (e) => this.handleShiftChange(e.target);
            td.appendChild(select);
            tr.appendChild(td);
          }
          const tdTotal = document.createElement('td'); tdTotal.innerHTML = `<b>${totalHours}</b>`; tr.appendChild(tdTotal);
          tbody.appendChild(tr);
        });
      }

      async handleShiftChange(select) {
        const userId = select.dataset.userId;
        const date = select.dataset.date;
        const shiftId = select.value ? parseInt(select.value) : null;
        const monthStr = date.slice(0, 7);
        select.className = `shift-select shift-${shiftId || 'none'} saving`;

        const { error } = await supabase.from('schedule').upsert({
          user_id: userId, date: date, month: monthStr, shift_id: shiftId, is_day_off: !shiftId
        }, { onConflict: 'user_id, date' });

        if (error) { alert('Ошибка сохранения!'); select.classList.add('error'); }
        else {
          select.classList.remove('saving');
          const idx = this.scheduleData.findIndex(s => s.user_id === userId && s.date === date);
          if (idx >= 0) this.scheduleData[idx].shift_id = shiftId;
          else this.scheduleData.push({ user_id: userId, date, month: monthStr, shift_id: shiftId });
        }
      }
    }

    // --- 5. INITIALIZATION & ROUTING ---
    document.addEventListener('DOMContentLoaded', async () => {
      currentUser = getCurrentUser();

      if (currentUser) {
        showAppView();
      } else {
        showLoginView();
      }
    });

    function showLoginView() {
      document.getElementById('login-view').style.display = 'flex';
      document.getElementById('app-view').style.display = 'none';
      initLoginEvents();
    }

    async function showAppView() {
      document.getElementById('login-view').style.display = 'none';
      document.getElementById('app-view').style.display = 'block';
      await initApp();
    }

    // --- LOGIN LOGIC ---
    function initLoginEvents() {
      const toggleBtn = document.getElementById('togglePassword');
      const passInput = document.getElementById('loginPassword');
      
      toggleBtn.onclick = () => {
        const type = passInput.getAttribute('type') === 'password' ? 'text' : 'password';
        passInput.setAttribute('type', type);
        toggleBtn.innerHTML = type === 'password' 
          ? '<svg viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>'
          : '<svg viewBox="0 0 24 24"><path d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.43-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-3.98.7l2.16 2.16C10.74 7.13 11.35 7 12 7zM2 4.27l2.28 2.28.46.46C3.08 8.3 1.78 10.02 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22 21 20.73 3.27 3 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15.02-.16c0-1.66-1.34-3-3-3l-.17.01z"/></svg>';
        toggleBtn.querySelector('svg').style.fill = 'var(--text-muted)';
      };

      document.getElementById('btnLogin').onclick = async () => {
        const login = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        const btn = document.getElementById('btnLogin');
        const err = document.getElementById('loginErrorMsg');

        if (!login || !password) { err.textContent = 'Заполните все поля'; return; }
        btn.disabled = true; 
        const originalText = btn.textContent;
        let dots = 0; const interval = setInterval(() => { dots = (dots + 1) % 4; btn.textContent = 'Входим' + '.'.repeat(dots); }, 300);
        err.textContent = 'Проверка...'; err.style.color = '#888';

        try {
          await loginUser(login, password);
          clearInterval(interval);
          err.style.color = '#4caf50'; err.textContent = 'Успешно!'; btn.textContent = 'Успешно!';
          setTimeout(() => location.reload(), 500);
        } catch (e) {
          clearInterval(interval); btn.textContent = originalText; btn.disabled = false;
          err.style.color = '#f44336'; err.textContent = e.message;
        }
      };
    }

    // --- APP LOGIC ---
    async function initApp() {
      // Header
      document.getElementById('headerLogin').textContent = currentUser.login || currentUser.full_name;
      const roles = { 'director': 'Директор', 'senior_seller': 'Старший', 'seller': 'Продавец' };
      document.getElementById('headerRole').textContent = roles[currentUser.role] || currentUser.role;

      // Profile Menu
      const pBtn = document.getElementById('profileBtn');
      const pMenu = document.getElementById('profileMenu');
      pBtn.onclick = (e) => { e.stopPropagation(); pMenu.style.display = pMenu.style.display === 'block' ? 'none' : 'block'; };
      document.addEventListener('click', () => pMenu.style.display = 'none');
      document.getElementById('logoutBtn').onclick = logoutUser;

      // Tabs
      const tabs = document.querySelectorAll('.tab');
      tabs.forEach(tab => {
        tab.onclick = (e) => {
          e.preventDefault();
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          tab.classList.add('active');
          document.getElementById(tab.getAttribute('data-tab')).classList.add('active');
        };
      });

      // Role Based Access
      const isAdmin = ['director', 'senior_seller'].includes(currentUser.role);
      if (isAdmin) {
        document.getElementById('adminTab').style.display = 'block';
        loadUsersTable();
        const scheduleManager = new ScheduleManager('schedule-manager');
        await scheduleManager.init();
      } else {
        document.getElementById('viewTeamSched').style.display = 'none';
      }

      // Init Components
      new Calendar('calendar-wrapper');
      loadContent();
      
      // Schedule Switch
      const btnMy = document.getElementById('viewMySched');
      const btnTeam = document.getElementById('viewTeamSched');
      btnMy.onclick = () => {
        document.getElementById('myScheduleView').style.display = 'block';
        document.getElementById('teamScheduleView').style.display = 'none';
        btnMy.classList.add('active'); btnTeam.classList.remove('active');
      };
      btnTeam.onclick = () => {
        document.getElementById('myScheduleView').style.display = 'none';
        document.getElementById('teamScheduleView').style.display = 'block';
        btnTeam.classList.add('active'); btnMy.classList.remove('active');
      };

      // Merch Upload
      const btnUpload = document.getElementById('btnUploadMerch');
      if(btnUpload) {
        btnUpload.onclick = () => document.getElementById('uploadMerchInput').click();
        document.getElementById('uploadMerchInput').onchange = handleMerchUpload;
      }
      
      // Create User
      const btnCreate = document.getElementById('btnCreateUser');
      if(btnCreate) btnCreate.onclick = createUserHandler;

      // 1S Search
      const searchInput = document.querySelector('#1s .search-input');
      const list = document.querySelector('#1s .list-group');
      async function load1S(q='') {
         list.innerHTML = '<div class="loader">Поиск...</div>';
         let query = supabase.from('manuals').select('*').order('title');
         if(q) query = query.ilike('title', `%${q}%`);
         const { data } = await query;
         list.innerHTML = '';
         if(!data || !data.length) { list.innerHTML = '<div>Ничего не найдено</div>'; return; }
         data.forEach(item => {
           const el = document.createElement('div'); el.style.padding='10px'; el.style.borderBottom='1px solid #333'; el.style.cursor='pointer';
           el.textContent = item.title;
           el.onclick = () => alert(item.content || 'Пусто');
           list.appendChild(el);
         });
      }
      load1S();
      searchInput.addEventListener('input', (e) => load1S(e.target.value));
    }

    async function loadContent() {
      const merchGrid = document.getElementById('merchGrid');
      if (merchGrid) {
        const items = await getMerchItems();
        merchGrid.innerHTML = items.length ? '' : '<p style="text-align:center;width:100%">Нет фото</p>';
        items.forEach(item => {
          const el = document.createElement('div');
          el.className = 'photo-card';
          el.style.backgroundImage = `url('${item.image_url}')`;
          el.innerHTML = `<div class="photo-title">${item.title}</div>`;
          merchGrid.appendChild(el);
        });
      }
    }

    async function handleMerchUpload(e) {
      const file = e.target.files[0];
      if (!file) return;
      const btn = document.getElementById('btnUploadMerch');
      const oldText = btn.textContent;
      btn.textContent = '...'; btn.disabled = true;
      try {
        const url = await uploadFile('photos', file);
        const title = prompt('Название:', 'Фото');
        if (title) { await createMerchItem(title, url); loadContent(); }
      } catch (err) { alert(err.message); } 
      finally { btn.textContent = oldText; btn.disabled = false; e.target.value = ''; }
    }

    async function loadUsersTable() {
      const tbody = document.querySelector('#usersTable tbody');
      if (!tbody) return;
      const users = await getAllEmployees();
      tbody.innerHTML = '';
      const canDelete = currentUser.role === 'director';
      users.forEach(u => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><b>${u.full_name}</b><br><small style="color:#888">${u.login} | ${u.password}</small></td>
          <td>${u.role}</td>
          <td>${canDelete ? `<button class="btn btn-sm" onclick="deleteUserHandler('${u.id}')" style="color:red">X</button>` : ''}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    window.deleteUserHandler = async (id) => {
      if (currentUser.role !== 'director') return alert('Только директор!');
      if(!confirm('Удалить?')) return;
      const { error } = await deleteEmployee(id);
      if (error) alert(error.message); else loadUsersTable();
    };

    async function createUserHandler() {
      const login = document.getElementById('newUserEmail').value;
      const password = document.getElementById('newUserPass').value;
      const fullName = document.getElementById('newUserName').value;
      const role = document.getElementById('newUserRole').value;
      if (!login || !password || !fullName) return alert('Заполните все поля');
      const { error } = await createEmployee({ login, password, full_name: fullName, role });
      if (error) alert(error.message); else { alert('Сотрудник создан!'); loadUsersTable(); }
    }
  </script>
</body>
</html>
